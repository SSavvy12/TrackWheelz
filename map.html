<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Map - Track Wheelz</title>
<link rel="stylesheet" href="style.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
header { background: #0066cc; color: white; padding: 10px; text-align: center; }
nav a { margin: 0 10px; color: white; text-decoration: none; font-weight: bold; }
.container { padding: 20px; max-width: 900px; margin: auto; }
#map { width: 100%; height: 400px; border: 3px solid #0066cc; border-radius: 12px; margin-top: 15px; }
#stats { background: #ffeb99; border: 4px solid #ff6600; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
#progressBar { background: #ddd; border-radius: 12px; overflow: hidden; margin: 10px auto; height: 25px; width: 90%; }
#progressFill { background: #00cc66; height: 100%; width: 0%; transition: width 0.5s; }
#tiersPanel { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
.tierBox { width: 120px; padding: 10px; border-radius: 12px; text-align: center; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; background: #ccc; color: #666; }
.tierCompleted { background: #66cc66; color: white; }
.tierCurrent { background: #ffcc33; color: #222; }
.tierLocked { background: #ccc; color: #666; }
.carIcon { font-size: 24px; line-height: 24px; text-align: center; }
.treasureIcon { font-size: 22px; line-height: 22px; text-align: center; cursor: pointer; }
#codePopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #cce6ff; border: 3px solid #3399ff; border-radius: 20px; padding: 20px 30px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 9999; color: #333; font-weight: bold; max-width: 90%; }
#codePopup h2 { margin: 0 0 10px 0; color: #1582ee; }
#codePopup p { margin: 5px 0; font-size: 16px; }
#codePopup ul { list-style: none; padding: 0; margin: 10px 0 0 0; }
#codePopup ul li { background: #fff0ff; margin: 3px 0; padding: 5px 10px; border-radius: 10px; }
#popupMessage { margin-top: 10px; font-weight: bold; color: #d35400; }
#codePopup button { margin-top: 10px; padding: 5px 15px; border: none; background: #ff66cc; color: white; border-radius: 10px; cursor: pointer; font-weight: bold; }
#codePopup button:hover { background: #406be4; }
.treasureInRange { filter: drop-shadow(0 0 8px lime); } /* green glow when in range */
</style>
</head>

<body>
<header>
<h1>Track Wheelz</h1>
<nav>
<a href="index.html">Home</a>
<a href="login.html" id="loginLink">Login</a>
<a href="map.html">Map</a>
<a href="#" id="logoutLink" style="display:none;">Logout</a>
</nav>
</header>

<div class="container">
<h2 id="welcomeMsg">Welcome!</h2>

<div id="stats">
<p style="font-size: 20px;">‚≠ê Points: <span id="points">0</span></p>
<p style="font-size: 20px;">üèÅ Level: <span id="level">1</span></p>
<div id="progressBar"><div id="progressFill"></div></div>
<p id="nextLevelText"></p>
</div>

<div id="tiersPanel"></div>

<div id="map"></div>
<p style="text-align:center;">Double-click a treasure chest üóùÔ∏è (desktop) / tap (mobile) to reveal your codes!</p>
</div>

<div id="codePopup">
<h2 id="popupBoxName"></h2>
<p id="popupUserCode"></p>
<ul id="popupOtherCodes"></ul>
<p id="popupMessage"></p>
<button onclick="document.getElementById('codePopup').style.display='none'">Close</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyB1c1NRWt9Rs2_bYb7VshMzR2d8PrENPSM",
  authDomain: "trackwheelz.firebaseapp.com",
  projectId: "trackwheelz",
  storageBucket: "trackwheelz.firebasestorage.app",
  messagingSenderId: "902612651501",
  appId: "1:902612651501:web:5b78cd6afcf5e91bde6be4",
  measurementId: "G-QSCJ3V0KJL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- UI Elements ---
const loginLink = document.getElementById("loginLink");
const logoutLink = document.getElementById("logoutLink");
const welcomeMsg = document.getElementById("welcomeMsg");

// --- Prompt for user name ---
let playerName = localStorage.getItem("playerName");
if(!playerName) {
  const nameInput = document.createElement("div");
  nameInput.style.position = "fixed";
  nameInput.style.top = "0"; nameInput.style.left = "0"; nameInput.style.width = "100%";
  nameInput.style.height = "100%"; nameInput.style.background = "rgba(0,0,0,0.6)";
  nameInput.style.display = "flex"; nameInput.style.alignItems = "center"; nameInput.style.justifyContent = "center";
  nameInput.style.zIndex = "10000";
  nameInput.innerHTML = `<div style="background:white;padding:20px;border-radius:15px;text-align:center;">
    <h2>Enter your name:</h2>
    <input id="playerNameInput" style="padding:5px;font-size:16px;border-radius:10px;" />
    <button id="playerNameBtn" style="margin-left:10px;padding:5px 10px;border-radius:10px;background:#3399ff;color:white;border:none;">OK</button>
  </div>`;
  document.body.appendChild(nameInput);
  document.getElementById("playerNameBtn").addEventListener("click",()=>{
    playerName = document.getElementById("playerNameInput").value || "Player";
    localStorage.setItem("playerName", playerName);
    welcomeMsg.textContent = `Welcome, ${playerName}!`;
    document.body.removeChild(nameInput);
  });
} else {
  welcomeMsg.textContent = `Welcome, ${playerName}!`;
}

// --- Auth State ---
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    loginLink.style.display = "none";
    logoutLink.style.display = "inline";
    // Only update welcome if userName not yet stored
    if(!playerName) welcomeMsg.textContent = `Welcome, ${user.email}!`;

    stats = await loadUserData(user.uid);
    updateStatsUI();
    setupMap(user.uid);
  }
});

logoutLink.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "index.html";
});

// --- Firestore Helpers ---
async function loadUserData(uid) {
  const ref = doc(db, "players", uid);
  const snap = await getDoc(ref);
  if (snap.exists()) return snap.data();
  const fresh = { points: 0, level: 1, claimedTiers: {} };
  await setDoc(ref, fresh);
  return fresh;
}

async function saveUserData(uid, data) {
  const ref = doc(db, "players", uid);
  await updateDoc(ref, data);
}

// --- Gameplay Logic ---
let stats = { points: 0, level: 1, claimedTiers: {} };

function updateStatsUI() {
  document.getElementById("points").textContent = stats.points;
  document.getElementById("level").textContent = stats.level;
  const needed = stats.level * 200;
  const progress = Math.min((stats.points / needed) * 100, 100);
  document.getElementById("progressFill").style.width = progress + "%";
  document.getElementById("nextLevelText").textContent = `Next level at ${needed} points`;
  updateTiersPanel();
}

function checkLevelUp() {
  const needed = stats.level * 200;
  if (stats.points >= needed) {
    stats.level++;
    alert(`üéâ Level Up! You‚Äôre now Level ${stats.level}!`);
  }
}

const tiers = [];
for (let i = 0; i < 8; i++) {
  const start = i*8 + 1, end = start+7;
  tiers.push({ tier: i+1, start, end });
}

function updateTiersPanel() {
  const panel = document.getElementById("tiersPanel");
  panel.innerHTML = "";
  tiers.forEach(t=>{
    const box = document.createElement("div");
    if (stats.level > t.end) box.className = "tierBox tierCompleted";
    else if (stats.level >= t.start && stats.level <= t.end) box.className = "tierBox tierCurrent";
    else box.className = "tierBox tierLocked";
    box.innerHTML = `Tier ${t.tier}<br>(Lv ${t.start}-${t.end})`;
    panel.appendChild(box);
  });
}

// --- Map Setup ---
async function setupMap(uid) {
  const map = L.map('map').setView([34.0007, -81.0348], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const carIcon = L.divIcon({ className: "carIcon", html: "üöô", iconSize: [24, 24], iconAnchor: [12, 12] });
  const treasureIcon = L.divIcon({ className: "treasureIcon", html: "üí∞", iconSize: [22, 22], iconAnchor: [11, 11] });

  const locations = [
    { name: "Park Entrance", coords: [34.0007, -81.0348], boxes: [{ id: "box1", name: "Lock Box", codes: ["1111","2222","3333","4444","5555","6666","7777","8888"] }] },
    { name: "Home Base", coords: [34.24388, -80.8128805], boxes: [{ id: "box2", name: "Lock Box", codes: ["7777","8888","9999","0000","1111","2222","3333","4444"] }] }
  ];

  let userMarker = null;
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      if (!userMarker) userMarker = L.marker([lat, lng], { icon: carIcon }).addTo(map).bindPopup("üìç You are here");
      else userMarker.setLatLng([lat, lng]);
      map.setView([lat, lng]);

      locations.forEach(loc => {
        loc.boxes.forEach((box, i) => {
          const boxCoords = box.exactCoords || [
            loc.coords[0] + 0.0003 * Math.cos(i * 2 * Math.PI / loc.boxes.length),
            loc.coords[1] + 0.0003 * Math.sin(i * 2 * Math.PI / loc.boxes.length)
          ];
          const distance = getDistanceFeet(lat, lng, boxCoords[0], boxCoords[1]);
          if (distance <= 50 && box.marker) box.marker.getElement()?.classList.add("treasureInRange");
          else if (box.marker) box.marker.getElement()?.classList.remove("treasureInRange");
        });
      });
    });
  }

  function getDistanceFeet(lat1, lon1, lat2, lon2) {
    const R = 6371e3; 
    const toRad = x => x * Math.PI / 180;
    const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
    const ŒîœÜ = toRad(lat2 - lat1), ŒîŒª = toRad(lon2 - lon1);
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c*3.28084;
  }

  // Add lockboxes
  locations.forEach(loc => {
    loc.boxes.forEach((box, i) => {
      const boxCoords = box.exactCoords || [
        loc.coords[0] + 0.0003 * Math.cos(i*2*Math.PI/loc.boxes.length),
        loc.coords[1] + 0.0003 * Math.sin(i*2*Math.PI/loc.boxes.length)
      ];
      const marker = L.marker(boxCoords, { icon: treasureIcon }).addTo(map);
      box.marker = marker;
      marker.bindPopup(`<b>üí∞ ${loc.name} - ${box.name}</b><br>Double-click/tap to see codes`);

      const handleClick = () => handleBoxClick(box, loc, uid, userMarker);
      // Desktop double-click
      marker.on("dblclick", handleClick);
      // Mobile tap
      marker.on("click", e=>{
        if(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
          handleClick();
        }
      });
    });
  });
}

// --- Handle box opening ---
async function handleBoxClick(box, loc, uid, userMarker) {
  if(!stats.claimedTiers[box.id]) stats.claimedTiers[box.id] = [];
  if(!userMarker){
    document.getElementById("popupBoxName").textContent="Too far!";
    document.getElementById("popupUserCode").textContent="";
    document.getElementById("popupOtherCodes").innerHTML="";
    document.getElementById("popupMessage").textContent="‚ö†Ô∏è Unable to determine your location. Enable GPS!";
    document.getElementById("codePopup").style.display="block";
    return;
  }

  const userLatLng = userMarker.getLatLng();
  const boxCoords = box.exactCoords || [loc.coords[0], loc.coords[1]];
  const distance = getDistanceFeet(userLatLng.lat,userLatLng.lng,boxCoords[0],boxCoords[1]);

  if(distance>50){
    document.getElementById("popupBoxName").textContent=`${box.name} @ ${loc.name}`;
    document.getElementById("popupUserCode").textContent="";
    document.getElementById("popupOtherCodes").innerHTML="";
    document.getElementById("popupMessage").textContent=`‚ö†Ô∏è You are too far from the lock box! (${Math.round(distance)} ft away)`;
    document.getElementById("codePopup").style.display="block";
    return;
  }

  const tierIndex = Math.floor((stats.level-1)/8);
  const ul = document.getElementById("popupOtherCodes");
  ul.innerHTML="";
  box.codes.forEach((code,t)=>{
    if(t<=tierIndex) ul.innerHTML+=`<li>Tier ${t+1} Code: ${code}</li>`;
  });

  let message="";
  if(!stats.claimedTiers[box.id].includes(tierIndex)){
    stats.claimedTiers[box.id].push(tierIndex);
    stats.points+=50;
    checkLevelUp();
    message=`üéâ You earned 50 points for Tier ${tierIndex+1}!`;
    await saveUserData(uid, stats);
  } else message="‚ö†Ô∏è Already opened for this tier. Reach a higher tier to unlock more!";

  document.getElementById("popupBoxName").textContent=`${box.name} @ ${loc.name}`;
  document.getElementById("popupUserCode").textContent=`üéØ Your Level (${stats.level}) Code: ${box.codes[tierIndex]}`;
  document.getElementById("popupMessage").textContent=message;
  document.getElementById("codePopup").style.display="block";

  updateStatsUI();
}
</script>
</body>
</html>
