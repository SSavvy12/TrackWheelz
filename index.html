<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Track Wheelz</title>
<link rel="stylesheet" href="style.css"/>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f8ff; text-align: center; }
header { background: #0066cc; color: white; padding: 10px; }
nav a { color: white; text-decoration: none; margin: 0 10px; font-weight: bold; }
.container { padding: 30px; }
h1 { font-size: 40px; margin-bottom: 10px; }
#stats { background: #ffeb99; border: 4px solid #ff6600; padding: 15px; border-radius: 15px; display: inline-block; margin-top: 20px; text-align: center; }
#progressBar { background: #ddd; border-radius: 12px; overflow: hidden; margin: 10px auto; height: 25px; width: 90%; }
#progressFill { background: #00cc66; height: 100%; width: 0%; transition: width 0.5s; }
#loginStatus { margin-top: 20px; font-size: 18px; }
button { background: #007bff; border: none; padding: 10px 20px; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
button:hover { background: #0056b3; }
#bonusBox { background: #c8f7c5; border: 3px solid #28a745; border-radius: 15px; padding: 20px; width: 250px; margin: 20px auto; }
#bonusMsg { color: #006400; margin-top: 10px; font-weight: bold; }
</style>
</head>

<body>
<header>
  <h1>Track Wheelz</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="login.html" id="loginLink">Login</a>
    <a href="map.html">Map</a>
    <a href="#" id="logoutLink" style="display:none;">Logout</a>
  </nav>
</header>

<div class="container">
  <h2 id="welcomeMsg">Welcome to Track Wheelz!</h2>

  <div id="stats" style="display:none;">
    <p style="font-size: 22px;">‚≠ê Points: <span id="points">0</span></p>
    <p style="font-size: 22px;">üèÅ Level: <span id="level">1</span></p>
    <div id="progressBar"><div id="progressFill"></div></div>
    <p id="nextLevelText"></p>

    <!-- üèÜ Daily Bonus Box -->
    <div id="bonusBox">
      <h3>üéÅ Daily Bonus</h3>
      <button id="dailyBonusBtn">Claim +50 Points</button>
      <p id="bonusMsg"></p>
    </div>
  </div>

  <div id="loginStatus">
    <p>Sign in to track your progress and unlock rewards across devices!</p>
    <a href="login.html"><button>Sign In</button></a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyB1c1NRWt9Rs2_bYb7VshMzR2d8PrENPSM",
  authDomain: "trackwheelz.firebaseapp.com",
  projectId: "trackwheelz",
  storageBucket: "trackwheelz.firebasestorage.app",
  messagingSenderId: "902612651501",
  appId: "1:902612651501:web:5b78cd6afcf5e91bde6be4",
  measurementId: "G-QSCJ3V0KJL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- UI Elements ---
const loginLink = document.getElementById("loginLink");
const logoutLink = document.getElementById("logoutLink");
const welcomeMsg = document.getElementById("welcomeMsg");
const statsDiv = document.getElementById("stats");
const loginStatus = document.getElementById("loginStatus");
const bonusBtn = document.getElementById("dailyBonusBtn");
const bonusMsg = document.getElementById("bonusMsg");

// --- Auth State ---
onAuthStateChanged(auth, async (user) => {
  if (user) {
    loginLink.style.display = "none";
    logoutLink.style.display = "inline";
    loginStatus.style.display = "none";
    statsDiv.style.display = "block";

    const ref = doc(db, "players", user.uid);
    const snap = await getDoc(ref);
    let data;

    if (snap.exists()) {
      data = snap.data();
      // If player doesn't have a name yet, ask for one
      if (!data.name) {
        const name = prompt("Enter your display name:");
        if (name) {
          await updateDoc(ref, { name });
          data.name = name;
        }
      }
    } else {
      // New user: ask for name and create record
      const name = prompt("Enter your display name:");
      data = { points: 0, level: 1, lastBonus: null, name: name || "Player" };
      await setDoc(ref, data);
    }

    welcomeMsg.textContent = `Welcome, ${data.name}!`;
    updateStatsUI(data.points || 0, data.level || 1);
    checkDailyBonus(data.lastBonus);

    // Enable button click
    bonusBtn.onclick = async () => {
      const now = new Date();
      if (canClaimBonus(data.lastBonus)) {
        const newPoints = (data.points || 0) + 50;
        const newData = {
          points: newPoints,
          lastBonus: now.toISOString()
        };
        await updateDoc(ref, newData);
        bonusMsg.textContent = "‚úÖ You received 50 points!";
        updateStatsUI(newPoints, data.level || 1);
        bonusBtn.disabled = true;
      } else {
        bonusMsg.textContent = "‚è≥ You already claimed your bonus today!";
      }
    };

  } else {
    // Not logged in
    loginLink.style.display = "inline";
    logoutLink.style.display = "none";
    statsDiv.style.display = "none";
    loginStatus.style.display = "block";
    welcomeMsg.textContent = "Welcome to Track Wheelz!";
  }
});

// --- Logout ---
logoutLink.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "index.html";
});

// --- Update Stats UI ---
function updateStatsUI(points, level) {
  document.getElementById("points").textContent = points;
  document.getElementById("level").textContent = level;
  const needed = level * 200;
  const progress = Math.min((points / needed) * 100, 100);
  document.getElementById("progressFill").style.width = progress + "%";
  document.getElementById("nextLevelText").textContent = `Next level at ${needed} points`;
}

// --- Daily Bonus Check ---
function canClaimBonus(lastBonus) {
  if (!lastBonus) return true;
  const last = new Date(lastBonus);
  const now = new Date();
  const diff = now - last;
  return diff > 24 * 60 * 60 * 1000; // 24 hours
}

function checkDailyBonus(lastBonus) {
  if (canClaimBonus(lastBonus)) {
    bonusBtn.disabled = false;
    bonusMsg.textContent = "üéâ Claim your 50 daily points!";
  } else {
    bonusBtn.disabled = true;
    bonusMsg.textContent = "‚è≥ You've already claimed your bonus today.";
  }
}
</script>
</body>
</html>

